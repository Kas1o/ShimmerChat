name: Create Release

on:
  push:
    tags:
      - 'v*'  # 匹配所有以 v 开头的标签，例如 v1.0.0, v0.5.2

jobs:
  release:
    runs-on: windows-latest  # 推荐使用 Windows，因为 Blazor Server 可能涉及 IIS 或特定路径处理；也可用 ubuntu-latest

    steps:
      - name: Checkout code including submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive  # 确保子模块被完整检出
          fetch-depth: 0         # 获取全部历史以便生成 changelog

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '10.0.x'  

      - name: Determine Version from Tag
        id: version
        run: |
          echo "Extracting version from tag ${{ github.ref }}"
          TAG_NAME=$(echo ${{ github.ref }} | sed 's|refs/tags/||')
          echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
        shell: bash

      - name: Restore dependencies
        run: |
          dotnet restore

      - name: Build project
        run: |
          dotnet build --configuration Release --no-restore

      - name: Publish Blazor Server App
        id: publish
        run: |
          dotnet publish ./ShimmerChat/ShimmerChat.csproj.csproj \
            --configuration Release \
            --no-build \
            --output ./publish-output \
            /p:PublishSingleFile=false \
            /p:SelfContained=false \
            /p:TargetFramework=net10.0  
        env:
          DOTNET_ROOT: ${{ env.DOTNET_ROOT }}

      - name: Generate Changelog
        id: changelog
        run: |
          # 获取上一个 tag（如果没有则使用初始 commit）
          last_tag=$(git describe --tags --abbrev=0 --all HEAD^ || echo "initial")
          if [ "$last_tag" = "initial" ]; then
            commits=$(git log --pretty=format:'- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))' HEAD)
          else
            commits=$(git log --pretty=format:'- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))' $last_tag..HEAD)
          fi

          # 输出 Markdown 格式日志
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$commits" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref }}
          name: ${{ steps.version.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ---
            Automatically generated by GitHub Actions.
          draft: false
          prerelease: false
          generate_release_notes: false  # 我们自己生成了内容
          files: publish-output/**/*     # 上传 publish-output 目录下所有文件
