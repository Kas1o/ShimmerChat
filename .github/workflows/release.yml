name: Create Release

on:
  push:
    tags:
      - 'v*'  # 如 v1.0.0, v0.5.2

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout code including submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0  # 获取完整历史以生成 changelog

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '10.0.x'  

      - name: Determine Version from Tag
        id: version
        run: |
          echo "Extracting version from tag ${{ github.ref }}"
          TAG_NAME=$(echo "${{ github.ref }}" | sed 's|refs/tags/||')
          echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
        shell: bash

      - name: Restore dependencies
        run: dotnet restore
        shell: pwsh

      - name: Build project
        run: dotnet build --configuration Release --no-restore
        shell: pwsh

      - name: Publish Blazor Server App
        run: |
          dotnet publish ./ShimmerChat/ShimmerChat.csproj `
            --configuration Release `
            --no-build `
            --output ./publish-output `
            /p:PublishSingleFile=false `
            /p:SelfContained=false `
            /p:TargetFramework=net10.0
        shell: pwsh
        env:
          DOTNET_ROOT: ${{ env.DOTNET_ROOT }}

      - name: Generate Changelog
        id: changelog
        run: |
          # 获取上一个 tag
          last_tag=$(git describe --tags --abbrev=0 --all HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$last_tag" ]; then
            # 没有上一个 tag，列出所有提交
            commits=$(git log --pretty=format:'- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))' HEAD)
          else
            # 从上一个 tag 到当前
            commits=$(git log --pretty=format:'- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))' $last_tag..HEAD)
          fi

          # 输出到 GITHUB_OUTPUT
          {
            echo "changelog<<EOF"
            echo "$commits"
            echo "EOF"
          } >> $GITHUB_OUTPUT
        shell: bash

      - name: Compress publish output into ZIP
        shell: pwsh
        run: |
          $tagName = '${{ github.ref }}'.Replace('refs/tags/', '')
          $zipName = "ShimmerChat-$tagName.zip"
          Compress-Archive -Path "publish-output/*" -DestinationPath "$zipName" -CompressionLevel Optimal
          Write-Output "Created archive: $zipName"
          echo "ZIP_FILE=$zipName" >> $env:GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref }}
          name: ${{ steps.version.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ---
            Automatically generated by GitHub Actions.
          draft: false
          prerelease: false
          generate_release_notes: false
          files: ${{ env.ZIP_FILE }}  # 只上传 zip 文件
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}  # 必须是具有 write:contents 权限的 PAT
