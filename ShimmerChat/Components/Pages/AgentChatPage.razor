@page "/agent/{AgentGuid}/{ChatGuid}"
@using ShimmerChatLib
@using SharperLLM.API
@using System.Collections.ObjectModel
@using System.Threading
@using ShimmerChat.Singletons
@using Microsoft.JSInterop

@inject ICompletionService completion
@inject IAIGenerationService aiGenerationService
@inject IPopupService popupService
@inject IJSRuntime JS
@inject IKVDataService KVData
@inject NavigationManager navigation

@if (chat != null)
{
	<div id="container">
		<div id="chat-info" class="shimmer-shadow-box">
			<label>You are having chat with: </label>
			<h2 @onclick="BackToAgentPage" style="cursor:pointer">@agent!.name</h2>
		</div>
		<div id="chat-main" @ref="ChatMainElement">
			@foreach (var message in messages)
			{
				<ShimmerChat.Components.SubComponents.Message Delete="() => DeleteMessage(message)" RegenerateFrom="() => RegenerateFromMessage(message)" message="message" MakeDirty="GetDirty" AgentName="@agent.name" />
			}
			<br />
			<br />
		</div>
		<div id="input-box" class="shimmer-shadow-box">
			<!-- 输入框内容 -->
			<textarea  @bind="inputText" @bind:event="oninput" @onkeydown="@(e => CheckEnter(e))" placeholder="Type your message here..." rows="3"></textarea>
			<div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px;">
				@if (generating)
				{
					<button class="btn btn-danger" @onclick="OnClickStopGenerationButton">停止生成</button>
				}
				else
				{
					<button class="btn btn-primary" @onclick="OnClickSendButton">发送</button>
				}
			</div>
		</div>
	</div>
	<ShimmerChat.Components.SubComponents.ChatPluginPanelContainer AgentGuid="agent.guid" ChatGuid="chat.Guid" @ref="ChatPluginPanelContainer"/>
	<style>

		.shimmer-content {
			padding: 0px !important; /* 覆盖掉主容器的padding，以实现无缝的背景图 */
		}

		/* 父级容器 */
		#container {
			position: relative;
			height: calc( 100vh - 4.7rem);
			display: flex;
			flex-direction: column;
			background: url( @($"/userimages/{agent.BackgroundGuid}.png") );
			background-size: cover;
			background-position: center;
			min-height: 100vh;
		}

		/* 聊天信息栏 */
		#chat-info {
		position: absolute; /* 固定在父级容器的左上角 */
		top: 0;
		left: 0;
		padding: 10px;
		z-index: 100;
		width: 100%;
		}

		/* 聊天主区域 */
		#chat-main {
		flex: 1; /* 占据剩余空间 */
		overflow-y: auto; /* 允许垂直滚动 */
		padding: 20px;
		margin-top: 80px; /* 为 #chat-info 预留空间 */
		margin-bottom: 100px; /* 为 #input-box 预留空间 */
		box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		}

		/* 输入框 */
		#input-box {
		position: absolute; /* 固定在父级容器的左下角 */
		bottom: 0;
		left: 0;
		width: 100%;
		padding: 15px;
		z-index: 100;
		box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
		}

		#input-box > textarea{
			width : 100%;
			border : none;
			resize: none;
			border-radius: 15px;
			padding: 5px;
		}
		
		/* 打字指示器动画 */
		.shimmer-typing-indicator {
			display: inline-block;
			animation: blink 1s infinite;
			font-weight: bold;
			font-size: 1.2em;
		}
		
		@@keyframes blink {
			0%, 50% { opacity: 1; }
			51%, 100% { opacity: 0; }
		}

		.shimmer-message {
			padding: 16px;
			border-radius: var(--radius-lg);
			margin: 8px 0;
			max-width: 100%;
			word-break: break-word;
			background-color: var(--color-card);
			border: 1px solid var(--color-border);
			box-shadow: var(--shadow-sm);
			transition: var(--transition);
		}

				.shimmer-message:hover {
					box-shadow: var(--shadow-md);
				}

		/* 消息头部 */
		.shimmer-message-head {
			font-size: 1.2rem;
			font-weight: 600;
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 12px;
			color: var(--color-text-primary);
		}

		/* 消息操作按钮 */
		.shimmer-message-head-action {
			font-size: 1rem;
			display: flex;
			gap: 12px;
			cursor: pointer;
			user-select: none;
		}

				.shimmer-message-head-action button {
					background: none;
					border: none;
					color: var(--color-text-secondary);
					cursor: pointer;
					padding: 4px 8px;
					border-radius: var(--radius-md);
					transition: var(--transition);
				}

						.shimmer-message-head-action button:hover {
						background-color: var(--color-surface);
						color: var(--color-primary);
					}

		/* 思考中消息样式 */
		.shimmer-message-thinking {
			backdrop-filter: blur(10px);
			background-color: var(--color-primary-light);
			border-radius: var(--radius-lg);
			padding: 20px;
			border: 1px solid var(--color-primary-light);
			color: var(--color-text-primary);
		}

		/* 工具调用样式 */
		.shimmer-toolcall {
			backdrop-filter: blur(10px);
			background-color: var(--color-surface);
			border: 1px solid var(--color-border);
			border-radius: var(--radius-lg);
			padding: 20px;
			margin: 12px 0;
			box-shadow: var(--shadow-sm);
		}
	</style>
}

@if(chat == null)
{
	<p>Chat @AgentGuid / @ChatGuid Not Found</p>
}

@code {

	#region 参数
	[Parameter]
	public string AgentGuid { get; set; } = string.Empty;
	[Parameter]
	public string ChatGuid { get; set; } = string.Empty; // The chat name to load
	#endregion

	#region 成员

	/// <summary>
	/// 指向聊天容器，用于在生成时自动滚动到底部 <see cref="AddLLMReplyStream"/> <see cref="MiscSettingsPage._autoScrollDown"/>
	/// </summary>
	ElementReference ChatMainElement; 

	bool generating = false; // 表示当前是否在生成中
	CancellationTokenSource? cts; // 用于取消生成任务的令牌源
	Message? currentAIMessage; // 当前正在生成的AI消息
	private Agent? agent; // 当前对话所属的Agent引用
	private Chat? chat; // 当前对话的引用

	/// <summary>
	/// 消息列表的引用，由 <see cref="OnParametersSet" /> 设置为对 <see cref="Chat.Messages"/> 的 引用。
	/// </summary>
	ObservableCollection<Message> messages = new ObservableCollection<Message>(); 
	string inputText { get; set; } = ""; // 当前正在输入的文本。

	bool throwExceptionInsteadOfPopupErrorMessage = false; // 抛出异常设置
	bool autoScrollDown = true; // 自动滚动设置

	ShimmerChat.Components.SubComponents.ChatPluginPanelContainer? ChatPluginPanelContainer;
	#endregion

	#region 交互
	void CheckEnter(KeyboardEventArgs e)
	{
		if (e.Key == "Enter" && !e.ShiftKey && !generating) // 检测是否按下 Enter 键
		{
			Send(); // 无论输入是否为空，都调用Send方法
		}
	}
	void OnClickStopGenerationButton()
	{
		StopGeneration();
	}
	void OnClickSendButton()
	{
		Send();
	}
	void BackToAgentPage()
	{
		navigation.NavigateTo($"/agent/{AgentGuid}");
	}
	#endregion

	#region 逻辑
	async void Send()
	{
		// 取消之前可能存在的生成任务
		CancelPreviousGeneration();

		if (chat == null || agent == null)
		{
			return;
		}

		// 只有当输入不为空时才添加用户消息
		if (!string.IsNullOrWhiteSpace(inputText))
			if (inputText.Trim().Length > 0)
			{
				var message = new Message()
			{
					message = new SharperLLM.Util.ChatMessage
					{
						Content= inputText // 使用输入框的内容
					},
					timestamp = DateTime.Now, // 设置消息的时间戳
					sender = ShimmerChatLib.Sender.User // 设置发送者，可以是 "User" 或其他标识
				};

				// 添加消息到聊天
				chat.AddMessage(message);
				ChatPluginPanelContainer?.OnUserMessage(message);
				inputText = ""; // 清空输入框
				GetDirty(); // 标记为脏数据以保存
			}

		// 无论输入是否为空，都启动AI生成任务
		new Task(AddLLMReplyStream).Start();
	}
	void StopGeneration()
	{
		if (cts != null)
		{
			try
			{
				cts.Cancel();
				cts.Dispose();
				cts = null;

				// 标记当前AI消息为非流式状态
				if (currentAIMessage != null)
				{
					currentAIMessage.IsStreaming = false;
				}

				generating = false;
				InvokeAsync(StateHasChanged);
			}
			catch (Exception ex)
			{
				if (throwExceptionInsteadOfPopupErrorMessage)
				{
					throw;
				}
				else
				{
					popupService.ShowAsync(ex.Message, "停止生成时出错");
				}
			}
		}
	}
	async void AddLLMReplyStream()
	{
		if (agent == null || chat == null)
			return;

		generating = true;

		// 创建新的CancellationTokenSource
		cts = new CancellationTokenSource();
		var cancellationToken = cts.Token;

		// 消息将在handleStreamResponses回调中创建

		try
		{
			await aiGenerationService.GenerateAIResponseStreamAsync(
				agent, chat,
				// 处理流式响应的函数
				handleStreamResponses: async (responseStream) =>
				{
					// 检查是否已经有currentAIMessage（重新生成场景）
					if (currentAIMessage == null)
					{
						// 创建新的AI消息
						currentAIMessage = new Message
						{
							message = new SharperLLM.Util.ChatMessage{ Content = "", thinking = string.Empty},
							timestamp = DateTime.Now,
							sender = ShimmerChatLib.Sender.AI,
							IsStreaming = true
						};
						messages.Add(currentAIMessage);
					}
					else
					{
						// 如果是重新生成，确保消息处于流式状态
						currentAIMessage.IsStreaming = true;
						// 清空当前版本内容以准备新生成
						if (currentAIMessage.CurrentVersion != null)
						{
							currentAIMessage.CurrentVersion.Content = "";
							currentAIMessage.CurrentVersion.thinking = null;
							currentAIMessage.CurrentVersion.toolCalls = null;
						}
					}
					
					await InvokeAsync(StateHasChanged);

					await foreach (var rsp in responseStream.WithCancellation(cancellationToken))
					{
						// 流式响应更新
						// 更新消息内容
						if (!string.IsNullOrEmpty(rsp.Body.Content))
						{
							if (currentAIMessage.CurrentVersion != null)
								currentAIMessage.CurrentVersion.Content = rsp.Body.Content;
							else
								currentAIMessage.message = new SharperLLM.Util.ChatMessage { Content = rsp.Body.Content };
						}

						// 如果有思考内容，更新思考内容
						if (rsp.Body.thinking != null)
						{
							if (currentAIMessage.CurrentVersion != null)
								currentAIMessage.CurrentVersion.thinking = rsp.Body.thinking;
							else if (currentAIMessage.message != null)
								currentAIMessage.message.thinking = rsp.Body.thinking;
						}

						if (rsp.Body.toolCalls != null)
						{
							if (currentAIMessage.CurrentVersion != null)
								currentAIMessage.CurrentVersion.toolCalls = rsp.Body.toolCalls;
							else if (currentAIMessage.message != null)
								currentAIMessage.message.toolCalls = rsp.Body.toolCalls;
						}

						if (autoScrollDown)
						{
							await JS.InvokeVoidAsync("scrollToBottom", ChatMainElement);
						}

						// 立即触发UI刷新，确保流式内容实时显示
						await InvokeAsync(StateHasChanged);
					}

					// 流式响应结束，标记为非流式状态
					if (currentAIMessage != null)
					{
						currentAIMessage.IsStreaming = false;
						ChatPluginPanelContainer?.OnAgentMessage(currentAIMessage);
						await InvokeAsync(StateHasChanged);
					}
				},
				// 处理工具调用的回调
				onToolCall: (toolCalls) =>
				{
					// 添加工具调用消息
					/*
					messages.Add(new Message
					{
						message = new SharperLLM.Util.ChatMessage{Content= null, thinking = null,  toolCalls = toolCalls },
						timestamp = DateTime.Now,
						sender = ShimmerChatLib.Sender.ToolCall
						});
					*/

									// 触发UI刷新
									InvokeAsync(StateHasChanged);
				},
				// 处理工具结果的回调
				onToolResult: (tuple) =>
				{
					var newMessage = new Message
					{
						message = new SharperLLM.Util.ChatMessage { Content = tuple.resp, id = tuple.id, thinking = null },
						timestamp = DateTime.Now,
						sender = ShimmerChatLib.Sender.ToolResult
					};
					// 工具调用结果
					messages.Add(newMessage);

					ChatPluginPanelContainer?.OnToolCallResult(newMessage);

					if (autoScrollDown)
					{
						JS.InvokeVoidAsync("scrollToBottom", ChatMainElement);
					}
					// 触发UI刷新
					InvokeAsync(StateHasChanged);
				},
				cancellationToken
			);
		}
		catch (OperationCanceledException)
		{
			// 操作被用户取消，这是预期行为，不需要显示错误
		}
		catch (Exception ex)
		{

			// 发生错误时，标记当前消息为非流式状态
			if (currentAIMessage != null)
			{
				currentAIMessage.IsStreaming = false;
			}

			if(throwExceptionInsteadOfPopupErrorMessage)
			{
				throw;
			}
			else
			{
				popupService.ShowAsync($"{ex.Message} \n {ex.InnerException?.Message ?? ""}", $"生成时出错！{ex.Source}");
			}	
		}
		finally
		{
			generating = false;
			cts?.Dispose();
			cts = null;
			currentAIMessage = null;
			GetDirty();
			await Refresh();

			// AI生成完成时调用通知
			await ShowNotificationWhenCompleted();
		}
	}
	void CancelPreviousGeneration()
	{
		if (cts != null)
		{
			cts.Cancel();
			cts.Dispose();
			cts = null;
		}

		// 如果有正在生成的消息，标记为非流式状态
		if (currentAIMessage != null)
		{
			currentAIMessage.IsStreaming = false;
			currentAIMessage = null;
		}
	}
	async void DeleteMessage(Message message)
	{
		// 如果删除的是当前正在生成的消息，取消生成
		if (message == currentAIMessage)
		{
			StopGeneration();
		}

		messages.Remove(message);
		await Refresh();
	}
	async void RegenerateFromMessage(Message message)
	{
		// 停止当前可能正在进行的生成
		StopGeneration();

		// 找到消息的索引
		int messageIndex = messages.IndexOf(message);

		// 如果找不到消息，直接返回
		if (messageIndex == -1) return;

		// 保存当前消息作为版本
		var currentContent = message.CurrentVersion?.Content ?? "";
		var currentThinking = message.CurrentVersion?.thinking ?? "";
		var currentToolCalls = message.CurrentVersion?.toolCalls;

		if (!string.IsNullOrEmpty(currentContent))
		{
			// 将当前内容添加为新版本
			var versionMessage = new SharperLLM.Util.ChatMessage
			{
				Content = currentContent,
				thinking = currentThinking,
				toolCalls = currentToolCalls != null ? new List<SharperLLM.API.ToolCall>(currentToolCalls) : null
			};
			message.AddVersion(versionMessage);
		}

		// 设置currentAIMessage为要重新生成的消息
		currentAIMessage = message;

		// 删除此消息之后的所有消息
		for (int i = messages.Count - 1; i > messageIndex; i--)
		{
			messages.RemoveAt(i);
		}

		// 保存更改
		GetDirty();
		await Refresh();

		// 启动新的AI回复生成（会复用currentAIMessage）
		new Task(AddLLMReplyStream).Start();
	}
	#endregion

	#region 初始化 & 参数设置
	protected override void OnInitialized()
	{
		if (bool.TryParse(KVData.Read("App", "throw_exception"), out var result))
		{
			throwExceptionInsteadOfPopupErrorMessage = result;
		}
		if (bool.TryParse(KVData.Read("App", "auto_scroll_down"), out var autoscroll))
		{
			autoScrollDown = autoscroll;
		}
	}
	protected override void OnParametersSet()
	{
		base.OnParametersSet();

		agent = null;
		chat = null;
		messages = new ObservableCollection<Message>();

		if (Guid.TryParse(AgentGuid, out var guid))
		{
			try
			{
				agent = Agent.Load(guid, KVData);
				if (agent != null)
				{
					var chats = agent.GetChats(KVData);
					chat = chats.FirstOrDefault(c => c.Guid.ToString() == ChatGuid);
					if (chat != null)
					{
						messages = chat.Messages ?? new ObservableCollection<Message>();
					}
				}
			}
			catch (Exception)
			{
				agent = null;
				chat = null;
				messages = new ObservableCollection<Message>();
			}
		}
	}
	#endregion

	#region IO
	private async Task ShowNotificationWhenCompleted()
	{
		try
		{
			// 检查用户是否启用了通知
			var notificationsEnabled = false;
			var notificationsEnabledStr = KVData.Read("App", "enable_notifications");
			if (bool.TryParse(notificationsEnabledStr, out var result))
			{
				notificationsEnabled = result;
			}

			// 如果用户未启用通知，则直接返回
			if (!notificationsEnabled)
			{
				return;
			}

			// 检查是否有AI消息
			var aiMessage = messages.LastOrDefault(m => m.sender == ShimmerChatLib.Sender.AI);
			if (aiMessage != null && !string.IsNullOrEmpty(aiMessage.CurrentVersion?.Content))
			{
				// 准备通知选项
				var notificationOptions = new
				{
					body = aiMessage.CurrentVersion.Content.Length > 100 ? aiMessage.CurrentVersion.Content.Substring(0, 100) + "..." : aiMessage.CurrentVersion.Content,
					icon = Assets["favicon.png"], // 可以使用项目中的图标
				};

				// 调用JavaScript中的通知函数
				await JS.InvokeVoidAsync("showNotification", $"来自 {agent?.name} 的新消息", notificationOptions);
			}
		}
		catch (Exception ex)
		{
			// 如果通知失败，记录错误但不中断程序
			Console.WriteLine($"显示通知时出错: {ex.Message}");
		}
	}
	void GetDirty()
	{
		chat.LastModifyTime = DateTime.Now;

		// Save the chat and agent directly
		if (chat != null)
			chat.Save(KVData);
		if (agent != null)
			agent.Save(KVData);
	}
	async Task Refresh()
	{
		await InvokeAsync(StateHasChanged);
	}
	#endregion
}

