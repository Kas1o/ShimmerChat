@page "/agent/{agentguid}/{chatname}"
@using ShimmerChatLib
@using SharperLLM.API
@using System.Collections.ObjectModel
@using System.Threading
@using ShimmerChat.Singletons
@using Microsoft.JSInterop

@inject ICompletionService completion
@inject IAIGenerationService aiGenerationService
@inject IPopupService popupService
@inject IJSRuntime JS
@inject IKVDataService KVData

@if (chat != null)
{
	<div id="container">
		<div id="chat-info" class="shimmer-shadow-box">
			<label>You are having chat with: </label>
			<h2>@agent.name</h2>
		</div>
		<div id="chat-main">
			@foreach (var message in messages)
			{
				<ShimmerChat.Components.SubComponents.Message Delete="() => DeleteMessage(message)" message="message" MakeDirty="GetDirty" AgentName="@agent.name" />
			}
		</div>
		<div id="input-box" class="shimmer-shadow-box">
			<!-- 输入框内容 -->
			<textarea  @bind="inputText" @bind:event="oninput" @onkeydown="@(e => CheckEnter(e))" placeholder="Type your message here..." rows="3"></textarea>
			<div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px;">
				@if (generating)
				{
					<button class="btn btn-danger" @onclick="StopGeneration">停止生成</button>
				}
				else
				{
					<button class="btn btn-primary" @onclick="Send">发送</button>
				}
			</div>
		</div>
	</div>
	<style>

		.shimmer-content {
			padding: 0px !important; /* 覆盖掉主容器的padding，以实现无缝的背景图 */
		}

		/* 父级容器 */
		#container {
			position: relative;
			height: calc( 100vh - 4.7rem);
			display: flex;
			flex-direction: column;
			background: url( @($"/userimages/{agent.BackgroundGuid}.png") );
			background-size: cover;
			background-position: center;
			min-height: 100vh;
		}

		/* 聊天信息栏 */
		#chat-info {
		position: absolute; /* 固定在父级容器的左上角 */
		top: 0;
		left: 0;
		padding: 10px;
		z-index: 100;
		width: 100%;
		}

		/* 聊天主区域 */
		#chat-main {
		flex: 1; /* 占据剩余空间 */
		overflow-y: auto; /* 允许垂直滚动 */
		padding: 20px;
		margin-top: 80px; /* 为 #chat-info 预留空间 */
		margin-bottom: 100px; /* 为 #input-box 预留空间 */
		box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		}

		/* 输入框 */
		#input-box {
		position: absolute; /* 固定在父级容器的左下角 */
		bottom: 0;
		left: 0;
		width: 100%;
		padding: 15px;
		z-index: 100;
		box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
		}

		#input-box > textarea{
			width : 100%;
			border : none;
			resize: none;
			border-radius: 15px;
			padding: 5px;
		}
		
		/* 打字指示器动画 */
		.shimmer-typing-indicator {
			display: inline-block;
			animation: blink 1s infinite;
			font-weight: bold;
			font-size: 1.2em;
		}
		
		@@keyframes blink {
			0%, 50% { opacity: 1; }
			51%, 100% { opacity: 0; }
		}

		.shimmer-message {
			padding: 16px;
			border-radius: var(--radius-lg);
			margin: 8px 0;
			max-width: 100%;
			word-break: break-word;
			background-color: var(--color-card);
			border: 1px solid var(--color-border);
			box-shadow: var(--shadow-sm);
			transition: var(--transition);
		}

				.shimmer-message:hover {
					box-shadow: var(--shadow-md);
				}

		/* 消息头部 */
		.shimmer-message-head {
			font-size: 1.2rem;
			font-weight: 600;
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 12px;
			color: var(--color-text-primary);
		}

		/* 消息操作按钮 */
		.shimmer-message-head-action {
			font-size: 1rem;
			display: flex;
			gap: 12px;
			cursor: pointer;
			user-select: none;
		}

				.shimmer-message-head-action button {
					background: none;
					border: none;
					color: var(--color-text-secondary);
					cursor: pointer;
					padding: 4px 8px;
					border-radius: var(--radius-md);
					transition: var(--transition);
				}

						.shimmer-message-head-action button:hover {
						background-color: var(--color-surface);
						color: var(--color-primary);
					}

		/* 思考中消息样式 */
		.shimmer-message-thinking {
			backdrop-filter: blur(10px);
			background-color: var(--color-primary-light);
			border-radius: var(--radius-lg);
			padding: 20px;
			border: 1px solid var(--color-primary-light);
			color: var(--color-text-primary);
		}

		/* 工具调用样式 */
		.shimmer-toolcall {
			backdrop-filter: blur(10px);
			background-color: var(--color-surface);
			border: 1px solid var(--color-border);
			border-radius: var(--radius-lg);
			padding: 20px;
			margin: 12px 0;
			box-shadow: var(--shadow-sm);
		}
	</style>
}

@if(chat == null)
{
	<p>Chat @agentguid / @chatname Not Found</p>
}

@code {
	bool generating = false;
	CancellationTokenSource? cts; // 用于取消生成任务的令牌源
	Message? currentAIMessage; // 当前正在生成的AI消息

	[Parameter]
	public string agentguid { get; set; } = string.Empty;

	private Agent? agent;

	[Parameter]
	public string chatname { get; set; } = string.Empty; // The chat name to load

	private Chat? chat;

	ObservableCollection<Message> messages = new ObservableCollection<Message>();

	string inputText { get; set; } = "";

	void CheckEnter(KeyboardEventArgs e)
	{
		if (e.Key == "Enter" && !e.ShiftKey && !generating) // 检测是否按下 Enter 键
		{
			Send(); // 无论输入是否为空，都调用Send方法
		}
	}

	ObservableCollection<Message> GetMessagesOrEmpty()
	{
		return messages;
	}

	async void Send()
	{
		// 取消之前可能存在的生成任务
		CancelPreviousGeneration();

		if (chat == null || agent == null)
		{
			return;
		}

		// 只有当输入不为空时才添加用户消息
		if (!string.IsNullOrWhiteSpace(inputText))
			if (inputText.Trim().Length > 0)
			{
				var message = new Message()
			{
					message = new SharperLLM.Util.ChatMessage
					{
						Content= inputText // 使用输入框的内容
					},
					timestamp = DateTime.Now, // 设置消息的时间戳
					sender = ShimmerChatLib.Sender.User // 设置发送者，可以是 "User" 或其他标识
				};

				// 添加消息到聊天
				chat.AddMessage(message);
				inputText = ""; // 清空输入框
				GetDirty(); // 标记为脏数据以保存
			}

		// 无论输入是否为空，都启动AI生成任务
		new Task(AddLLMReplyStream).Start();
	}

	// 停止生成
	void StopGeneration()
	{
		if (cts != null)
		{
			try
			{
				cts.Cancel();
				cts.Dispose();
				cts = null;

				// 标记当前AI消息为非流式状态
				if (currentAIMessage != null)
				{
					currentAIMessage.IsStreaming = false;
				}

				generating = false;
				InvokeAsync(StateHasChanged);
			}
			catch (Exception ex)
			{
				if (throwExceptionInsteadOfPopupErrorMessage)
				{
					throw;
				}
				else
				{
					popupService.ShowAsync(ex.Message, "停止生成时出错");
				}
			}
		}
	}

	// 取消之前的生成任务
	void CancelPreviousGeneration()
	{
		if (cts != null)
		{
			cts.Cancel();
			cts.Dispose();
			cts = null;
		}

		// 如果有正在生成的消息，标记为非流式状态
		if (currentAIMessage != null)
		{
			currentAIMessage.IsStreaming = false;
			currentAIMessage = null;
		}
	}

	bool throwExceptionInsteadOfPopupErrorMessage = false;
	protected override void OnInitialized()
	{
		if (bool.TryParse(KVData.Read("App", "throw_exception"), out var result))
		{
			throwExceptionInsteadOfPopupErrorMessage = result;
		}
	}

	protected override void OnParametersSet()
	{
		base.OnParametersSet();

		agent = null;
		chat = null;
		messages = new ObservableCollection<Message>();

		if (Guid.TryParse(agentguid, out var guid))
		{
			try
			{
				agent = Agent.Load(guid, KVData);
				if (agent != null)
				{
					var chats = agent.GetChats(KVData);
					chat = chats.FirstOrDefault(c => c.Name == chatname);
					if (chat != null)
					{
						messages = chat.Messages ?? new ObservableCollection<Message>();
					}
				}
			}
			catch (Exception)
			{
				agent = null;
				chat = null;
				messages = new ObservableCollection<Message>();
			}
		}
	}

	async void AddLLMReplyStream()
	{
		if (agent == null || chat == null)
			return;

		generating = true;

		// 创建新的CancellationTokenSource
		cts = new CancellationTokenSource();
		var cancellationToken = cts.Token;

		// 消息将在handleStreamResponses回调中创建

		try
		{
			await aiGenerationService.GenerateAIResponseStreamAsync(
				agent, chat,
				// 处理流式响应的函数
				handleStreamResponses: async (responseStream) =>
				{
					// 在handleStreamResponses内部创建新的AI消息
					currentAIMessage = new Message
					{
						message = new SharperLLM.Util.ChatMessage{ Content = "", thinking = string.Empty},
						timestamp = DateTime.Now,
						sender = ShimmerChatLib.Sender.AI,
						IsStreaming = true
					};
					messages.Add(currentAIMessage);
					await InvokeAsync(StateHasChanged);

					await foreach (var rsp in responseStream.WithCancellation(cancellationToken))
					{
						// 流式响应更新
						// 更新消息内容
						if (!string.IsNullOrEmpty(rsp.Body.Content))
						{
							currentAIMessage.message.Content = rsp.Body.Content;
						}

						// 如果有思考内容，更新思考内容
						if (rsp.Body.thinking != null)
						{
							currentAIMessage.message.thinking = rsp.Body.thinking;
						}

						if (rsp.Body.toolCalls != null)
						{
							currentAIMessage.message.toolCalls = rsp.Body.toolCalls;
						}

						// 立即触发UI刷新，确保流式内容实时显示
						await InvokeAsync(StateHasChanged);
					}
				
					// 流式响应结束，标记为非流式状态
					if (currentAIMessage != null)
					{
						currentAIMessage.IsStreaming = false;
						await InvokeAsync(StateHasChanged);
					}
				},
				// 处理工具调用的回调
				onToolCall: (toolCalls) =>
				{
					// 添加工具调用消息
					/*
					messages.Add(new Message
					{
						message = new SharperLLM.Util.ChatMessage{Content= null, thinking = null,  toolCalls = toolCalls },
						timestamp = DateTime.Now,
						sender = ShimmerChatLib.Sender.ToolCall
					});
					*/
					
					// 触发UI刷新
					InvokeAsync(StateHasChanged);
				},
				// 处理工具结果的回调
				onToolResult: (tuple) =>
				{
					// 工具调用结果
					messages.Add(new Message
					{
						message = new SharperLLM.Util.ChatMessage{ Content = tuple.resp, id = tuple.id, thinking = null},
						timestamp = DateTime.Now,
						sender = ShimmerChatLib.Sender.ToolResult
					});
					
					// 触发UI刷新
					InvokeAsync(StateHasChanged);
				},
				cancellationToken
			);
		}
		catch (OperationCanceledException)
		{
			// 操作被用户取消，这是预期行为，不需要显示错误
		}
		catch (Exception ex)
		{
			
			// 发生错误时，标记当前消息为非流式状态
			if (currentAIMessage != null)
			{
				currentAIMessage.IsStreaming = false;
			}

			if(throwExceptionInsteadOfPopupErrorMessage)
			{
				throw;
			}
			else
			{
				popupService.ShowAsync($"{ex.Message} \n {ex.InnerException?.Message ?? ""}", $"生成时出错！{ex.Source}");
			}	
		}
		finally
		{
			generating = false;
			cts?.Dispose();
			cts = null;
			currentAIMessage = null;
			GetDirty();
			await Refresh();
		}
	}

	async void DeleteMessage(Message message)
	{
		// 如果删除的是当前正在生成的消息，取消生成
		if (message == currentAIMessage)
		{
			StopGeneration();
		}
		
		messages.Remove(message);
		await Refresh();
	}

	void GetDirty()
	{
		// Save the chat and agent directly
		if (chat != null)
			chat.Save(KVData);
		if (agent != null)
			agent.Save(KVData);
	}

	async Task Refresh()
	{
		await InvokeAsync(StateHasChanged);
	}
}

