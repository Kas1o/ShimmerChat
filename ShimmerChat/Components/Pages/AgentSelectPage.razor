@page "/agentselect"
@using System.Collections.ObjectModel;
@inject NavigationManager navigation
@inject IStringLocalizer<AgentSelectPage> l
@inject IKVDataService kvDataService
@inject IPopupService PopupService

<h3>@l["AgentSelectPage"]</h3>
<div style="display:flex">
	<button class="btn btn-primary" @onclick="OpenCreateAgentMenu">@l["Create New Agent"]</button>
	<div>
		<InputFile OnChange="InputFileChanged"/>
		<button class="btn btn-primary"	@onclick="Import" >Import</button>
	</div>
</div>
<div class="shimmer-group">
	<div class="shimmer-grid">
		@foreach (var agent in agents)
		{
			<div class="shimmer-grid-item shimmer-grid-agent-item fixed-size">
					<div class="content-wrapper">
						<div class="agent-item-content" style="background-image: url('/userimages/@(agent.AvatarGuid).png');" @onclick="()=> NavigateToAgent( agent.guid.ToString())">
							@agent.name
						</div>
					</div>
					<button class="agent-delete-btn" @onclick:stopPropagation @onclick="()=> ShowDeleteConfirmation(agent)">
						×
					</button>
				</div>
		}
	</div>
</div>

@if (CreatePopupVisible)
{
	<div class="shimmer-popup-overlay" @onclick="() => CreatePopupVisible=false">
		<div class="shimmer-popup-content" @onclick:stopPropagation>
			<h5>@l["Create new Agent popup title"]</h5>
			<label>@l["Name:"]</label>
			<input class="shimmer-input" @bind=popupNewAgentName/>
			<label>@l["Description:"]</label>
			<textarea class="shimmer-textarea" @bind=popupNewAgentDescription/>
			<label>@l["Greeting:"]</label>
			<textarea class="shimmer-textarea" @bind=popupNewAgentGreeting/>
			<button class="btn btn-dark" @onclick="CreateNewAgent">@l["Create"]</button>
		</div>
	</div>
}

@if (DeletePopupVisible)
{
	<div class="shimmer-popup-overlay" @onclick="() => DeletePopupVisible=false">
		<div class="shimmer-popup-content" @onclick:stopPropagation>
			<h5>@l["Delete Agent popup title"]</h5>
			<p>@string.Format(l["Delete Agent confirmation message"], AgentToDelete?.name)</p>
			<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
				<button class="btn btn-secondary" @onclick="() => DeletePopupVisible=false">@l["Cancel"]</button>
				<button class="btn btn-danger" @onclick="DeleteAgentConfirmed">@l["Delete"]</button>
			</div>
		</div>
	</div>
}

<style>
	.shimmer-grid-agent-item {
		position: relative;
		color: var(--color-text-primary);
		overflow: hidden;
		border: 2px solid var(--color-border);
		background-color: var(--color-card);
		border-radius: 8px;
		overflow: hidden;
	}

	/* 固定尺寸的网格项 */
	.shimmer-grid-item.fixed-size {
		width: 280px;
		height: 420px;
		min-height: 0;
		padding: 0;
		overflow: hidden;
	}

	/* 用于保持固定尺寸的容器 */
	.shimmer-grid-item.fixed-size .content-wrapper {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		box-sizing: border-box;
	}

	.agent-item-content {
		position: relative;
		width: 100%;
		height: 100%;
		color: white;
		text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
		font-weight: bold;
		background-size: cover;
		background-position: center;
		background-blend-mode: overlay;
		display: flex;
		align-items: center;
		justify-content: center;
		text-align: center;
	}

	.agent-item-content::after {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: 0;
	}

	.agent-item-content > * {
		position: relative;
		z-index: 1;
	}

	.agent-delete-btn {
		position: absolute;
		top: 5px;
		right: 5px;
		background: rgba(0, 0, 0, 0.5);
		color: white;
		border: none;
		border-radius: 50%;
		width: 28px;
		height: 28px;
		font-size: 18px;
		line-height: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		opacity: 0;
		z-index: 2;
		transition: all 0.3s ease;
	}

	.shimmer-grid-agent-item:hover .agent-delete-btn {
		opacity: 1;
	}

	.agent-delete-btn:hover {
		background: var(--color-error);
	}

	.shimmer-grid-agent-item:hover {
		border-color: var(--color-primary);
		background-color: var(--color-surface);
		transform: translateY(-2px);
		box-shadow: var(--shadow-md);
	}

	.shimmer-popup-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: rgba(0, 0, 0, 0.6);
		display: flex;
		justify-content: center;
		align-items: center;
		z-index: 1000;
		backdrop-filter: blur(4px);
	}


	.shimmer-popup-content {
		background-color: var(--color-card);
		padding: 24px;
		border-radius: var(--radius-xl);
		box-shadow: var(--shadow-lg);
		border: 1px solid var(--color-border);
		max-width: 90vw;
		max-height: 90vh;
		overflow-y: auto;
		min-width: 300px;
		width: fit-content;
	}
</style>

@code {
	bool CreatePopupVisible { get; set; } = false;
	bool DeletePopupVisible { get; set; } = false;
	Agent? AgentToDelete { get; set; } = null;

	#region Popup
	string popupNewAgentName { get; set; } = "new agent";
	string popupNewAgentDescription { get; set; } = "this is a cool agent!";
	string popupNewAgentGreeting { get; set; } = "Hello! How can I help you today?";
	#endregion
	List<Agent> agents
	{
		get 
		{
			var agentGuids = Agent.GetAllAgentGuids(kvDataService);
			var result = new List<Agent>();
			foreach (var guid in agentGuids)
			{
				try
				{
					result.Add(Agent.Load(guid, kvDataService));
				}
				catch (Exception ex)
				{
					// Skip any agents that fail to load
				}
			}
			return result;
		}
	}

	void OpenCreateAgentMenu()
	{
		CreatePopupVisible = true;
	}

	void CreateNewAgent()
	{
		// Validate input
		if (popupNewAgentName == "")
			popupNewAgentName = "new agent"; // Default name if empty"

		// Create the new agent
		var newAgent = Agent.Create
		(
			popupNewAgentName,
			popupNewAgentDescription,
			popupNewAgentGreeting
		);

		// Save the agent
		newAgent.Save(kvDataService);

		// Add the agent to the all agents list
		Agent.AddAgentToAll(newAgent, kvDataService);

		CreatePopupVisible = false;
	}

	void NavigateToAgent(string guid)
	{
		navigation.NavigateTo($"/agent/{guid}");
	}

	void ShowDeleteConfirmation(Agent agent)
	{
		AgentToDelete = agent;
		DeletePopupVisible = true;
	}

	void DeleteAgentConfirmed()
	{
		if (AgentToDelete != null)
		{
			// Remove agent from the __AllAgents__ list
			Agent.RemoveAgentFromAll(AgentToDelete, kvDataService);

			// Reset popup state
			DeletePopupVisible = false;
			AgentToDelete = null;
		}
	}

	IBrowserFile File { get; set; }
	void InputFileChanged(InputFileChangeEventArgs e)
	{
		File = e.File;
	}

	async Task<byte[]> ReadFullyAsync(Stream stream)
	{
		using var memoryStream = new MemoryStream();
		var buffer = new byte[16384]; // 16KB 缓冲
		int bytesRead;
		while ((bytesRead = await stream.ReadAsync(buffer)) > 0)
		{
			await memoryStream.WriteAsync(buffer.AsMemory(0, bytesRead));
		}
		return memoryStream.ToArray();
	}

	// 使用：
	async Task Import()
	{
		if(File == null)
		{
			await PopupService.ShowAsync("未选择 Agent 文件。");
			return;
		}
		var originStream = File.OpenReadStream(maxAllowedSize: 1024 * 1024 * 80);
		var buffer = await ReadFullyAsync(originStream);
		var content = System.Text.Encoding.UTF8.GetString(buffer);

		var newAgent = Agent.Import(content);
		if (agents.Any(x => x.guid == newAgent.guid))
		{
			await PopupService.ShowAsync("已经存在同Agent");
		}

		Agent.AddAgentToAll(newAgent, kvDataService);
		StateHasChanged();
	}
}
