@page "/contextmanager"
@inject NavigationManager Navigation
@inject IStringLocalizer<ContextManagerPage> l
@inject IUserData userData
@inject IContextModifierService contextModifierService

<h3>Context Manager</h3>

<!-- 补全设置 -->
<h4>Completion Settings</h4>
@if (userData.ApiSettings.Count == 0)
{
    <div class="alert alert-warning" style="margin-top: 20px;">
        <h4>No API Settings Found</h4>
        <p>You need to configure API settings before using the Context Manager.</p>
        <button class="btn btn-primary" @onclick="NavigateToApiSettings">Go to API Settings</button>
    </div>
}
else
{
    @if (UsingOpenAIAndTextCompletion)
    {
        <h5 style="color:red">
            Use OpenAI API with Text Completion is not recommend. Most endpoints do not support it.
        </h5>
    }

    <label>Completion Type:</label>
    <select @bind="_selectedCompletionType" class="form-select" style="width:auto;display:inline-block;margin-left:8px;">
        @if (AllowChatCompletion)
        {
            <option value="chat-completion">Chat Completion</option>
        }
        @if (AllowTextCompletion)
        {
            <option value="text-completion">Text Completion</option>
        }
    </select>

    <br />
    <br />

    @if (completionType == CompletionType.TextCompletion)
    {
        <h5>Text Completion Settings</h5>
        <select @bind="_selectedTextCompletionIndex" class="form-select" style="width:auto;display:inline-block;">
            @for (int i = 0; i < textCompletionSettings.Count; i++)
            {
                <option value="@i">@textCompletionSettings[i].name</option>
            }
        </select>
        <button class="btn btn-primary" style="margin:5px" @onclick="CreateNewTextCompletionSetting">Create New Text Completion Setting Profile</button>
        @if (topTextCompletionSetting != null)
        {
            <div class="shimmer-group" style="margin-top:16px;">
                <h5>Name:</h5>
                <textarea class="form-control" rows="2" @bind="topTextCompletionSetting.name"></textarea>
                <h5>System Message Template:</h5>
                <textarea class="form-control" rows="2" @bind="topTextCompletionSetting.SystemMessageTemplate"></textarea>
                <h5>User Message Template:</h5>
                <textarea class="form-control" rows="2" @bind="topTextCompletionSetting.UserMessageTemplate"></textarea>
                <h5>Char Message Template:</h5>
                <textarea class="form-control" rows="2" @bind="topTextCompletionSetting.CharMessageTemplate"></textarea>
            </div>
        }
    }

    @if (completionType == CompletionType.ChatCompletion)
    {
        <h5>Chat Completion Settings</h5>
        <!-- 可根据需要扩展 Chat Completion 的设置 -->
    }

    <br />
}


<!-- 上下文修改器 -->
<h4>Context Modifier</h4>

<div class="shimmer-group" style="margin-top:16px;">
    <h5>Available Context Modifiers:</h5>
    <select @bind="_selectedModifierName" class="form-select" style="width:auto;display:inline-block;">
        <option value="">-- Select a Context Modifier --</option>
        @foreach (var modifier in contextModifierService.LoadedModifiers)
        {
            <option value="@modifier.info.Name">@modifier.info.Name - @modifier.info.Description</option>
        }
    </select>
</div>

<div class="shimmer-group" style="margin-top:8px;">
    <h5>Input Value:</h5>
    <textarea @bind="_modifierInput" class="form-control" rows="3" placeholder="Enter input value for the selected Context Modifier..."></textarea>
    <button class="btn btn-primary" style="margin-top:8px;" @onclick="AddModifier" disabled="@string.IsNullOrEmpty(_selectedModifierName)">Add to Active List</button>
</div>

<div class="shimmer-group" style="margin-top:16px;">
    <h5>Active Context Modifiers:</h5>
    @if (contextModifierService.ActivatedModifiers.Any())
    {
        <ul class="list-group">
            @foreach (var modifier in contextModifierService.ActivatedModifiers)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@modifier.Name</strong>
                        @if (!string.IsNullOrEmpty(modifier.Value))
                        {
                            <small class="d-block text-muted">@modifier.Value</small>
                        }
                    </div>
                    <button class="btn btn-danger btn-sm" @onclick="() => RemoveModifier(contextModifierService.ActivatedModifiers.IndexOf(modifier))">Remove</button>
                </li>
            }
        </ul>
    }
    else
    {
        <p class="text-muted">No active context modifiers</p>
    }
</div>

<button class="btn btn-primary" style="margin:5px" @onclick="SaveAll">Save</button>

@code {
    ObservableCollection<TextCompletionSetting> textCompletionSettings => userData.textCompletionSettings;

    // ContextModifier相关变量
    private string? _selectedModifierName;
    private string _modifierInput = string.Empty;

    private int _selectedTextCompletionIndex
    {
        get => userData.CurrentTextCompletionSettingIndex;
        set
        {
            userData.CurrentTextCompletionSettingIndex = value;
        }
    }
    TextCompletionSetting? topTextCompletionSetting =>
        (_selectedTextCompletionIndex >= 0 && _selectedTextCompletionIndex < textCompletionSettings.Count)
            ? textCompletionSettings[_selectedTextCompletionIndex]
            : null;

    private string _selectedCompletionType
    {
        get => completionType == CompletionType.ChatCompletion ? "chat-completion" : "text-completion";
        set
        {
            userData.CompletionType = value switch
            {
                "chat-completion" => CompletionType.ChatCompletion,
                "text-completion" => CompletionType.TextCompletion,
                _ => CompletionType.ChatCompletion
            };
        }
    }
    private CompletionType completionType => userData.CompletionType;

    private bool AllowChatCompletion =>
        userData.ApiSettings.Count > 0 && userData.CurrentAPISettingIndex >= 0 && userData.CurrentAPISettingIndex < userData.ApiSettings.Count
            ? userData.ApiSettings[userData.CurrentAPISettingIndex].Type switch
            {
                ApiSettingType.Ollama => true,
                ApiSettingType.Kobold => false,
                ApiSettingType.OpenAI => true,
                _ => throw new InvalidOperationException(l["UnsupportedAPISettingTypeMessage"])
            }
            : false;
    
    private bool AllowTextCompletion =>
        userData.ApiSettings.Count > 0 && userData.CurrentAPISettingIndex >= 0 && userData.CurrentAPISettingIndex < userData.ApiSettings.Count
            ? userData.ApiSettings[userData.CurrentAPISettingIndex].Type switch
            {
                ApiSettingType.Ollama => true,
                ApiSettingType.Kobold => true,
                ApiSettingType.OpenAI => true,
                _ => throw new InvalidOperationException(l["UnsupportedAPISettingTypeMessage"])
            }
            : false;
    
    private bool UsingOpenAIAndTextCompletion =>
        userData.ApiSettings.Count > 0 && userData.CurrentAPISettingIndex >= 0 && userData.CurrentAPISettingIndex < userData.ApiSettings.Count
            ? (userData.CompletionType == CompletionType.TextCompletion) && (userData.ApiSettings[userData.CurrentAPISettingIndex].Type == ApiSettingType.OpenAI)
            : false;

    private void CreateNewTextCompletionSetting()
    {
        textCompletionSettings.Add(new TextCompletionSetting{ name = "New Text Completion Setting" });
        _selectedTextCompletionIndex = textCompletionSettings.Count - 1;
    }

    private void SaveAll()
    {
        userData.SaveUserData();
        // 保存激活的ContextModifier
        contextModifierService.SaveActivatedModifiers();
        Navigation.NavigateTo(Navigation.Uri, true);
    }
    
    private void NavigateToApiSettings()
    {
        // 假设API设置页面的路由是 "/apisettings"
        // 如果实际路由不同，请修改为正确的路由
        Navigation.NavigateTo("/apisettings");
    }

    private void AddModifier()
    {
        if (!string.IsNullOrEmpty(_selectedModifierName))
        {
            contextModifierService.ActivateModifier(_selectedModifierName, _modifierInput);
            // 重置输入，以便添加下一个
            _modifierInput = string.Empty;
        }
    }

    private void RemoveModifier(int modifierIdx)
    {
        contextModifierService.RemoveActivatedModifier(modifierIdx);
    }
}