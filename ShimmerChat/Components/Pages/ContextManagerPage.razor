@page "/contextmanager"
@using ShimmerChat.Components.SubComponents
@inject NavigationManager Navigation
@inject IStringLocalizer<ContextManagerPage> l
@inject IUserData userData
@inject IContextModifierService contextModifierService
@inject IPopupService popupService

<h3>@l["TITLE"] </h3>

<!-- 补全设置 -->
<h4>@l["COMPLETION_SETTINGS_TITLE"]</h4>
@if (userData.ApiSettings.Count == 0)
{
    <div class="alert alert-warning" style="margin-top: 20px;">
        <h4>@l["NO_API_SETTING_FOUND_TITLE"]</h4>
        <p>@l["NO_API_SETTING_FOUND_CONTENT"]</p>
        <button class="btn btn-primary" @onclick="NavigateToApiSettings">@l["GO_API_SETTING_BUTTON"]</button>
    </div>
}
else
{
    @if (UsingOpenAIAndTextCompletion)
    {
        <h5 style="color:red">
            @l["USE_OPENAI_TEXT_COMPLETION_WARNING"]
        </h5>
    }

    <label>@l["COMPLETION_TYPE_LABEL"]</label>
    <select @bind="_selectedCompletionType" class="form-select" style="width:auto;display:inline-block;margin-left:8px;">
        @if (AllowChatCompletion)
        {
            <option value="chat-completion">@l["CHAT_COMPLETION_OPTION"]</option>
        }
        @if (AllowTextCompletion)
        {
            <option value="text-completion">@l["TEXT_COMPLETION_OPTION"]</option>
        }
    </select>

    <br />
    <br />

    @if (completionType == CompletionType.TextCompletion)
    {
        <h5>@l["TEXT_COMPLETION_SETTINGS_TITLE"]</h5>
        <select @bind="_selectedTextCompletionIndex" class="form-select" style="width:auto;display:inline-block;">
            @for (int i = 0; i < textCompletionSettings.Count; i++)
            {
                <option value="@i">@textCompletionSettings[i].name</option>
            }
        </select>
        <button class="btn btn-primary" style="margin:5px" @onclick="CreateNewTextCompletionSetting">Create New Text Completion Setting Profile</button>
        @if (topTextCompletionSetting != null)
        {
            <div class="shimmer-group" style="margin-top:16px;">
                <h5>@l["NAME:"]</h5>
                <textarea class="form-control" rows="2" @bind="topTextCompletionSetting.name"></textarea>
                <h5>@l["SYSTEM_MESSAGE_TEMPLATE"]</h5>
                <textarea class="form-control" rows="2" @bind="topTextCompletionSetting.SystemMessageTemplate"></textarea>
                <h5>@l["USER_MESSAGE_TEMPLATE"]</h5>
                <textarea class="form-control" rows="2" @bind="topTextCompletionSetting.UserMessageTemplate"></textarea>
                <h5>@l["AGENT_MESSAGE_TEMPLATE"]</h5>
                <textarea class="form-control" rows="2" @bind="topTextCompletionSetting.CharMessageTemplate"></textarea>
            </div>
        }
    }

    @if (completionType == CompletionType.ChatCompletion)
    {
        <h5>@l["CHAT_COMPLETION_SETTINGS_TITLE"]</h5>
        <!-- 可根据需要扩展 Chat Completion 的设置 -->
    }

    <br />
}


<!-- 上下文修改器 -->
<h4>@l["CONTEXT_MODIFIER_TITLE"]</h4>

<button class="btn btn-primary" style="margin:5px" @onclick="ShowAddModifierPopup">@l["CM_ADD"]</button>

<div class="shimmer-group" style="margin-top:16px;">
    <h5>@l["ACTIVE_CM"]</h5>
    @if (contextModifierService.ActivatedModifiers.Any())
    {
        <div class="list-group" ondragover="event.preventDefault();" @ondrop="() => HandleDrop()">
            @foreach (var modifier in contextModifierService.ActivatedModifiers)
            {
                <div class="list-group-item d-flex justify-content-between align-items-center" 
                     draggable="true" 
                     @ondragstart="() => HandleDragStart(contextModifierService.ActivatedModifiers.IndexOf(modifier))"
                     @ondragover="() => HandleDragOver(contextModifierService.ActivatedModifiers.IndexOf(modifier))"
                     data-index="@contextModifierService.ActivatedModifiers.IndexOf(modifier)">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-grip-vertical" style="margin-right: 10px; cursor: move; color: #6c757d;"></i>
                        <div>
                            <strong>@modifier.Name</strong>
                            @if (!string.IsNullOrEmpty(modifier.Value))
                            {
                                <small class="d-block text-muted">@modifier.Value</small>
                            }
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" @onclick="() => RemoveModifier(contextModifierService.ActivatedModifiers.IndexOf(modifier))">Remove</button>
                </div>
            }
        </div>
    }
    else
    {
        <p class="text-muted">@l["NO_ACTIVE_CM"]</p>
    }
</div>

<button class="btn btn-primary" style="margin:5px" @onclick="SaveAll">Save</button>

    @if (_showAddModifierPopup)
    {
        <AddContextModifierPopup @ref="_addModifierPopup" OnConfirm="(result) => OnAddModifierConfirmed(result)" OnClose="() => HideAddModifierPopup()" />
    }

@code {
    // 添加自定义弹窗组件引用
    private AddContextModifierPopup? _addModifierPopup;
    ObservableCollection<TextCompletionSetting> textCompletionSettings => userData.textCompletionSettings;

    // ContextModifier相关变量
    private string? _selectedModifierName;
    private string _modifierInput = string.Empty;

    private int _selectedTextCompletionIndex
    {
        get => userData.CurrentTextCompletionSettingIndex;
        set
        {
            userData.CurrentTextCompletionSettingIndex = value;
        }
    }
    TextCompletionSetting? topTextCompletionSetting =>
        (_selectedTextCompletionIndex >= 0 && _selectedTextCompletionIndex < textCompletionSettings.Count)
            ? textCompletionSettings[_selectedTextCompletionIndex]
            : null;

    private string _selectedCompletionType
    {
        get => completionType == CompletionType.ChatCompletion ? "chat-completion" : "text-completion";
        set
        {
            userData.CompletionType = value switch
            {
                "chat-completion" => CompletionType.ChatCompletion,
                "text-completion" => CompletionType.TextCompletion,
                _ => CompletionType.ChatCompletion
            };
        }
    }
    private CompletionType completionType => userData.CompletionType;

    private bool AllowChatCompletion =>
        userData.ApiSettings.Count > 0 && userData.CurrentAPISettingIndex >= 0 && userData.CurrentAPISettingIndex < userData.ApiSettings.Count
            ? userData.ApiSettings[userData.CurrentAPISettingIndex].Type switch
            {
                ApiSettingType.Ollama => true,
                ApiSettingType.Kobold => false,
                ApiSettingType.OpenAI => true,
                _ => throw new InvalidOperationException(l["UnsupportedAPISettingTypeMessage"])
            }
            : false;
    
    private bool AllowTextCompletion =>
        userData.ApiSettings.Count > 0 && userData.CurrentAPISettingIndex >= 0 && userData.CurrentAPISettingIndex < userData.ApiSettings.Count
            ? userData.ApiSettings[userData.CurrentAPISettingIndex].Type switch
            {
                ApiSettingType.Ollama => true,
                ApiSettingType.Kobold => true,
                ApiSettingType.OpenAI => true,
                _ => throw new InvalidOperationException(l["UnsupportedAPISettingTypeMessage"])
            }
            : false;
    
    private bool UsingOpenAIAndTextCompletion =>
        userData.ApiSettings.Count > 0 && userData.CurrentAPISettingIndex >= 0 && userData.CurrentAPISettingIndex < userData.ApiSettings.Count
            ? (userData.CompletionType == CompletionType.TextCompletion) && (userData.ApiSettings[userData.CurrentAPISettingIndex].Type == ApiSettingType.OpenAI)
            : false;

    private void CreateNewTextCompletionSetting()
    {
        textCompletionSettings.Add(new TextCompletionSetting{ name = "New Text Completion Setting" });
        _selectedTextCompletionIndex = textCompletionSettings.Count - 1;
    }

    private void SaveAll()
    {
        userData.SaveUserData();
        // 保存激活的ContextModifier
        contextModifierService.SaveActivatedModifiers();
        Navigation.NavigateTo(Navigation.Uri, true);
    }
    
    private void NavigateToApiSettings()
    {
        // 假设API设置页面的路由是 "/apisettings"
        // 如果实际路由不同，请修改为正确的路由
        Navigation.NavigateTo("/apisettings");
    }

    private bool _showAddModifierPopup = false;

    private void ShowAddModifierPopup()
    {
        _showAddModifierPopup = true;
    }

    private void HideAddModifierPopup()
    {
        _showAddModifierPopup = false;
    }

    private void OnAddModifierConfirmed(object result)
    {
        // 解析弹窗返回的结果
        var modifierInfo = result as dynamic;
        if (modifierInfo != null)
        {
            string modifierName = modifierInfo.ModifierName;
            string inputValue = modifierInfo.InputValue;
            contextModifierService.ActivateModifier(modifierName, inputValue);
        }
        HideAddModifierPopup();
    }

    private void AddModifier()
    {
        if (!string.IsNullOrEmpty(_selectedModifierName))
        {
            contextModifierService.ActivateModifier(_selectedModifierName, _modifierInput);
            // 重置输入，以便添加下一个
            _modifierInput = string.Empty;
        }
    }

    // 拖拽排序相关变量和方法
    private int _dragIndex = -1;
    private int _dropTargetIndex = -1;

    private void HandleDragStart(int index)
    {
        _dragIndex = index;
    }

    private void HandleDragOver(int index)
    {
        _dropTargetIndex = index;
        // 这里可以添加视觉反馈，比如高亮显示目标位置
    }

    private void HandleDrop()
    {
        if (_dragIndex == -1 || _dropTargetIndex == -1 || _dragIndex == _dropTargetIndex)
            return;

        contextModifierService.ReorderActivatedModifier(_dragIndex, _dropTargetIndex);
        _dragIndex = -1;
        _dropTargetIndex = -1;
    }

    private void RemoveModifier(int modifierIdx)
    {
        contextModifierService.RemoveActivatedModifier(modifierIdx);
    }
}