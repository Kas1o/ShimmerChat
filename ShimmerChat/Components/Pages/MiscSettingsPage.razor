@page "/misc"

@using Microsoft.JSInterop
@inject IKVDataService KVData
@inject IJSRuntime JS

<h3>MiscSettingsPage</h3>

<div class="shimmer-group">
	<h4>App Settings</h4>

	<input type="checkbox" class="form-check-input" id="throw-exception" @bind="_throwExceptionInsteadOfPopupErrorMessage" />
	<label class="form-check-label" for="throw-exception">Throw exception instead of popup error message</label>
	
	<input type="checkbox" class="form-check-input" id="enable-notifications" @bind="_enableNotifications" />
	<label class="form-check-label" for="enable-notifications">Enable desktop notifications</label>
	
	<button class="btn btn-outline-primary" @onclick="RequestNotificationPermission" style="margin-left: 10px;">Request Notification Permission</button>
	<span style="margin-left: 10px;">Current status: <strong>@notificationPermissionStatus</strong></span>

	<input type="button" class="form-check-input" id="auto-scroll-down" @bind="_autoScrollDown" />
	<label class="form-check-label" for="auto-scroll-down">Auto scroll down</label>
</div>

<div class="shimmer-group">
	<h4>User Settings</h4>

	<label class="form-check-label" for="username">User Name</label>
	<input type="text" class="form-control" id="username" @bind="_UserName" />
</div>

@code {
	private bool _throwExceptionInsteadOfPopupErrorMessage
	{
		get => field;
		set
		{
			if (field == value) return;
			field = value;
			Save();
		}
	} = false;

	private bool _enableNotifications
	{
		get => field;
		set
		{
			if (field == value) return;
			field = value;
			Save();
		}
	} = false;

	private string _UserName
	{
		get => field;
		set
		{
			if (field == value) return;
			field = value;
			Save();
		}
	} = "";

	private bool _autoScrollDown
	{
		get => field;
		set
		{
			if (field == value) return;
			field = value;
			Save();
		}
	} = true;


	private string notificationPermissionStatus = "Unknown";

	bool Initialized = false;
	private void Save()
	{
		if (!Initialized) return;
		KVData.Write("App", "throw_exception", _throwExceptionInsteadOfPopupErrorMessage ? "true": "false");
		KVData.Write("App", "enable_notifications", _enableNotifications ? "true": "false");
		KVData.Write("App", "auto_scroll_down", _autoScrollDown ? "true": "false");
		KVData.Write("User", "username", _UserName);
	}

	protected override async Task OnInitializedAsync()
	{
		if(bool.TryParse(KVData.Read("App", "throw_exception"), out var result)){
			_throwExceptionInsteadOfPopupErrorMessage = result;
		}
		if(bool.TryParse(KVData.Read("App", "enable_notifications"), out var notificationResult)){
			_enableNotifications = notificationResult;
		}
		if (bool.TryParse(KVData.Read("App", "auto_scroll_down"), out var autoscroll))
		{
			_autoScrollDown = autoscroll;
		}
		_UserName = KVData.Read("User", "username") ?? "";
		Initialized = true;
		
		// 获取当前通知权限状态
		notificationPermissionStatus = await JS.InvokeAsync<string>("eval", "Notification.permission");
		StateHasChanged();
	}
	
	private async Task RequestNotificationPermission()
	{
		var granted = await JS.InvokeAsync<bool>("requestNotificationPermission");
		if (granted)
		{
			notificationPermissionStatus = "Granted";
			// 同时启用通知设置
			_enableNotifications = true;
		}
		else
		{
			notificationPermissionStatus = "Denied";
		}
		StateHasChanged();
	}
}
