@page "/pluginpanel/{PanelName?}"
@using ShimmerChat.Singletons
@inject IPluginPanelService PluginPanelService

<PageTitle>插件面板 - @PanelTitle</PageTitle>

<div class="plugin-panel-container">
    @if (panelType != null)
    {
        <h1 class="text-2xl font-bold mb-4">@PanelTitle</h1>
        <div class="panel-content bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
            <DynamicComponent Type="panelType" />
        </div>
    }
    else if (string.IsNullOrEmpty(PanelName))
    {
        <h1 class="text-2xl font-bold mb-4">插件面板列表</h1>
        <div class="panel-list grid grid-cols-1 md:grid-cols-2 gap-4">
            @if (pluginPanels.Count > 0)
            {
                @foreach (var panel in pluginPanels)
                {
                    <div class="panel-card p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" @onclick="() => NavigateToPanel(panel.Name)">
                        <h3 class="text-lg font-semibold">@panel.Name</h3>
                        <p class="text-gray-600 dark:text-gray-300">@panel.Description</p>
                    </div>
                }
            }
            else
            {
                <p class="col-span-full text-gray-500">暂无可用的插件面板</p>
            }
        </div>
    }
    else
    {
        <h1 class="text-2xl font-bold mb-4">面板不存在</h1>
        <div class="bg-red-50 text-red-500 p-4 rounded-lg">
            <p>未找到名称为 "@PanelName" 的插件面板</p>
            <a href="/pluginpanel" class="text-blue-500 hover:underline">返回面板列表</a>
        </div>
    }
</div>

@code {
    [Parameter]
    public string? PanelName { get; set; }
    [Inject]
    public NavigationManager Navigation { get; set; } = null!;

    private Type? panelType;
    private string PanelTitle => panelType != null ? PanelName : "插件面板";
    private List<PluginPanelInfo> pluginPanels = new();

    protected override async Task OnInitializedAsync()
    {
        // 确保插件面板服务已加载完成
        await Task.Delay(100); // 短暂延迟确保服务初始化
        
        if (!string.IsNullOrEmpty(PanelName))
        {
            panelType = PluginPanelService.GetPluginPanelType(PanelName);
            // 如果面板类型为空但PanelName不为空，可能是插件尚未加载完成
            if (panelType == null)
            {
                // 尝试重新获取所有面板，确保服务已刷新
                PluginPanelService.RefreshPluginPanels();
                panelType = PluginPanelService.GetPluginPanelType(PanelName);
            }
        }
        else
        {
            pluginPanels = PluginPanelService.GetPluginPanels();
        }
    }
    
    private void NavigateToPanel(string panelName)
    {
        Navigation.NavigateTo($"/pluginpanel/{Uri.EscapeDataString(panelName)}", true);
    }
}