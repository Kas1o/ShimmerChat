@inject IPluginPanelService PluginPanelService

<div class="plugin-sidebar @(_isExpanded ? "sidebar-expanded" : "sidebar-collapsed")">
	<button class="sidebar-toggle" @onclick="ToggleSidebar" title="@(_isExpanded ? "收起" : "展开")">
		<i class="@(_isExpanded ? "bi bi-chevron-right" : "bi bi-chevron-left")"></i>
	</button>
	
	<div class="sidebar-content">
		<h5 class="sidebar-title">插件面板</h5>
		
		@foreach (var item in PluginPanelInfos)
		{
			<details class="plugin-item">
				<summary class="plugin-summary">
					<span class="plugin-name">@item.Name</span>
					<span class="plugin-arrow bi bi-chevron-down"></span>
				</summary>
				@if (!string.IsNullOrEmpty(item.Description))
				{
					<p class="plugin-description">@item.Description</p>
				}
				<div class="plugin-content">
					<DynamicComponent Type="item.PanelType" Parameters="Parameters"/>
				</div>
			</details>
		}
	</div>
</div>

<style>
	.plugin-sidebar {
		position: fixed;
		top: 0;
		right: 0;
		height: 100vh;
		background: var(--bs-body-bg, #fff);
		border-left: 1px solid var(--bs-border-color, #dee2e6);
		box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
		display: flex;
		flex-direction: column;
		z-index: 1050;
		transition: width 0.3s ease;
	}

	.sidebar-collapsed {
		width: 0px;
	}

	.sidebar-expanded {
		width: 640px;
	}

	.sidebar-toggle {
		position: absolute;
		left: -48px;
		top: 50%;
		transform: translateY(-50%);
		width: 48px;
		height: 48px;
		border: none;
		background: var(--bs-primary, #0d6efd);
		color: white;
		border-radius: 8px 0 0 8px;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.25rem;
		transition: background 0.2s;
	}

	.sidebar-toggle:hover {
		background: var(--bs-primary-dark, #0b5ed7);
	}

	.sidebar-content {
		flex: 1;
		overflow-y: auto;
		padding: 1rem;
		display: none;
	}

	.sidebar-expanded .sidebar-content {
		display: block;
	}

	.sidebar-title {
		margin: 0 0 1rem 0;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid var(--bs-primary, #0d6efd);
		font-weight: 600;
		color: var(--bs-body-color, #212529);
	}

	.plugin-item {
		background: var(--bs-tertiary-bg, #f8f9fa);
		border: 1px solid var(--bs-border-color, #dee2e6);
		border-radius: 8px;
		margin-bottom: 0.75rem;
		overflow: hidden;
	}

	.plugin-summary {
		padding: 0.75rem 1rem;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: space-between;
		background: var(--bs-secondary-bg, #e9ecef);
		font-weight: 500;
		color: var(--bs-body-color, #212529);
		user-select: none;
		transition: background 0.2s;
	}

	.plugin-summary:hover {
		background: var(--bs-secondary, #e9ecef);
	}

	.plugin-summary::-webkit-details-marker {
		display: none;
	}

	.plugin-name {
		flex: 1;
	}

	.plugin-arrow {
		transition: transform 0.2s;
		font-size: 0.875rem;
		color: var(--bs-secondary-color, #6c757d);
	}

	details[open] .plugin-arrow {
		transform: rotate(180deg);
	}

	.plugin-description {
		padding: 0.5rem 1rem;
		margin: 0;
		font-size: 0.875rem;
		color: var(--bs-secondary-color, #6c757d);
		background: var(--bs-body-bg, #fff);
		border-bottom: 1px solid var(--bs-border-color, #dee2e6);
	}

	.plugin-content {
		padding: 0.75rem;
		background: var(--bs-body-bg, #fff);
	}

	.plugin-content > * {
		max-width: 100%;
	}
</style>

@code {
	[Parameter]
	public Guid ChatGuid { get; set; }

	[Parameter]
	public Guid AgentGuid { get; set; }

	private Dictionary<string, object> Parameters => new Dictionary<string, object>
	{
		["ChatGuid"] = ChatGuid,
		["AgentGuid"] = AgentGuid,
		["EventHandlerReg"] = RegisterEventHandler
	};

	private bool _isExpanded = false;

	List<PluginPanelInfo> PluginPanelInfos;

	protected override void OnInitialized()
	{
		this.PluginPanelInfos = PluginPanelService.GetPluginPanels()
			.Where(x => x.PanelDisplayPlace == ShimmerChatLib.Panel.PanelDisplayPlace.Chat)
			.ToList();
	}

	private void ToggleSidebar()
	{
		_isExpanded = !_isExpanded;
	}

	private void RegisterEventHandler(ShimmerChatLib.Panel.IChatPanelEventHandler eventHandler)
	{
		if(eventHandler != null)
			EventHandlers.Add(eventHandler);
	}

	List<ShimmerChatLib.Panel.IChatPanelEventHandler> EventHandlers = [];

	public void OnToolCallResult(ShimmerChatLib.Message message)
	{
		foreach(var handler in EventHandlers)
		{
			handler.OnToolCallResult(message);
		}
	}
	public void OnUserMessage(ShimmerChatLib.Message message)
	{
		foreach (var handler in EventHandlers)
		{
			handler.OnUserMessage(message);
		}
	}
	public void OnAgentMessage(ShimmerChatLib.Message message)
	{
		foreach (var handler in EventHandlers)
		{
			handler.OnAgentMessage(message);
		}
	}
}
