@using Markdig
@using Markdig.Extensions.Tables

@inject IStringLocalizer<Message> l
@inject IJSRuntime JS
@inject IMessageDisplayService MessageDisplayService


<div class="shimmer-message">
	<div class="shimmer-message-head">
		<div>@sender</div>
		<div class="shimmer-message-head-action">
			<div @onclick="e => DeleteThisMessage()">
				@l["BUTTON_DELETE"]
			</div>
			<div @onclick="CopyContentToClipboard">
				@l["BUTTON_COPY"]
			</div>
			<div @onclick="EnterEditMode">
				@l["BUTTON_EDIT"]
			</div>
		</div>
	</div>
	@if(message.thinking != null)
	@if(message.thinking != String.Empty)
	{
		<div class="shimmer-message-thinking">
			@message.thinking
		</div>
	}
	@if (isEditMode)
	{
		<div>
			<textarea @bind="editContent" rows="4" style="width:100%"></textarea>
			<button class="btn btn-success" @onclick="SaveEdit">@l["BUTTON_SAVE"]</button>
			<button class="btn" @onclick="CancelEdit">@l["BUTTON_CANCEL"]</button>
		</div>
	}
	else
	{
		@DisplayContent
	}
</div>


@code {
	[Parameter]
	public Action Delete { get; set; } = null;

	[Parameter]
	public Action MakeDirty { get; set; } = null!; // Callback to make the parent component dirty

	[Parameter]
	public ShimmerChatLib.Message message { get; set; } = null!; // The message object to display
	[Parameter]
	public string Sender { get; set; } = "AI";

	bool isEditMode = false;
	string editContent = string.Empty;

	string stringContent => message.message.Content; // The string content of the message

	MarkupString DisplayContent => MessageDisplayService.RenderMarkdown(stringContent);

	string imageContent => message.message.ImageBase64; // The base64 string for the image content, if any

	string sender => message.sender;

	// 渲染逻辑已迁移到IMessageDisplayService单例服务中
// 之前每个Message组件都会创建一个新的MarkdownPipeline实例，这是不必要的资源消耗
// 现在所有组件共享同一个服务实例，大幅减少了内存占用和初始化开销

	void DeleteThisMessage()
	{
		Delete();
	}

	async Task CopyContentToClipboard()
	{
		await JS.InvokeVoidAsync("copyTextToClipboard", stringContent);
	}

	void EnterEditMode()
	{
		if (isEditMode)
		{
			CancelEdit();
			return;
		}
		isEditMode = true;
		editContent = stringContent;
	}

	void SaveEdit()
	{
		message.message.Content = editContent;
		isEditMode = false;
		MakeDirty?.Invoke();
	}

	void CancelEdit()
	{
		isEditMode = false;
	}
}
