@attribute [PluginPanel("DynPrompt ç¼–è¾‘å™¨", "ç®¡ç†å’Œç¼–è¾‘ DynPrompt é›†åˆå’Œæç¤ºè¯")]

@using ShimmerChatLib.Interface
@using ShimmerChatBuiltin.DynPrompt
@using Newtonsoft.Json
@inject IJSRuntime JS

@inject IKVDataService pluginData



<div class="shimmer-content p-4">
    <h2 class="text-2xl font-bold">DynPrompt ç¼–è¾‘å™¨</h2>
    
    <!-- æ–°å»º DynPromptSet -->
    <div class="shimmer-group">
        <h3 class="text-xl font-semibold">åˆ›å»ºæ–°çš„ DynPromptSet</h3>
        <div class="d-flex gap-3 mt-3 align-items-center flex-wrap">
            <input type="text" class="shimmer-input flex-1 @(validationErrors.ContainsKey("newSetName") ? "border-danger" : "")" 
                   @bind="newSetName" placeholder="è¾“å…¥ DynPromptSet åç§°" />
            @if (validationErrors.ContainsKey("newSetName"))
            {
                <div class="text-danger text-sm">@validationErrors["newSetName"]</div>
            }
            <button class="btn" @onclick="CreateNewSet" disabled="@string.IsNullOrWhiteSpace(newSetName)">
                åˆ›å»º
            </button>
        </div>
    </div>

    <!-- DynPromptSet åˆ—è¡¨ -->
    <div class="shimmer-group mt-5">
        <h3 class="text-xl font-semibold">å·²æœ‰çš„ DynPromptSet (@sets.Count)</h3>
        
        @if (sets.Count == 0)
        {
            <p class="text-muted mt-3">æš‚æ—  DynPromptSetï¼Œè¯·åˆ›å»ºæ–°çš„é›†åˆã€‚</p>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-3">
                @foreach (var set in sets)
                {
                    <div class="card cursor-pointer p-3 hover:shadow-md transition-shadow duration-200 @(selectedSet?.Name == set.Name ? "border-primary shadow-md" : "")"
                         @onclick="() => EditSet(set)">
                        <div class="set-header d-flex justify-content-between w-100">
                            <h4 class="mb-0">@set.Name</h4>
                            <div class="set-actions d-flex gap-2">
                                <button class="btn btn-sm" @onclick:stopPropagation @onclick="() => EditSet(set)" title="ç¼–è¾‘">âœï¸</button>
                                <button class="btn btn-sm bg-danger text-white" @onclick:stopPropagation @onclick="async () => await DeleteSet(set)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="set-content mt-2">
                            <p class="text-sm text-muted">åŒ…å« @set.Terms.Count ä¸ªåŠ¨æ€æç¤ºè¯</p>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- ç¼–è¾‘ DynPromptSet -->
    @if (selectedSet != null)
    {
        <div class="shimmer-group mt-5">
            <h3>ç¼–è¾‘: @selectedSet.Name</h3>
            
            <div class="set-info">
                <div class="d-flex gap-3 mt-3 align-items-center">
                    <label class="mt-1">é›†åˆåç§°:</label>
                    <input type="text" class="shimmer-input" @bind="editingSetName" />
                    <button class="btn" @onclick="UpdateSetName" disabled="@string.IsNullOrWhiteSpace(editingSetName)">
                        æ›´æ–°åç§°
                    </button>
                </div>
            </div>

            <!-- DynPromptTerm åˆ—è¡¨ -->
            <div class="mt-4">
                <h4>åŠ¨æ€æç¤ºè¯åˆ—è¡¨ (@selectedSet.Terms.Count)</h4>
                
                @if (selectedSet.Terms.Count == 0)
                {
                    <p class="text-muted mt-2">è¯¥é›†åˆæš‚æ— åŠ¨æ€æç¤ºè¯ï¼Œè¯·æ·»åŠ ã€‚</p>
                }
                else
                {
                    <div class="space-y-3 mt-2">
                        @foreach (var term in selectedSet.Terms)
                        {
                            <div class="card p-3 @(editingTerm == term ? "border-primary" : "")">
                                <div class="term-header d-flex justify-content-between">
                                    <h5 class="mb-0">@term.Name</h5>
                                    <div class="term-actions d-flex gap-2">
                                        <button class="btn btn-sm" @onclick="() => EditTerm(term)" title="ç¼–è¾‘">âœï¸</button>
                                        <button class="btn btn-sm bg-danger text-white" @onclick="async () => await DeleteTerm(term)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                                    </div>
                                </div>
                                <div class="term-preview mt-2">
                                    <p class="text-sm"><strong>å†…å®¹:</strong> @(term.Content.Length > 100 ? term.Content.Substring(0, 100) + "..." : term.Content)</p>
                                    <p class="text-sm"><strong>æ³¨å…¥æ¨¡å¼:</strong> @term.InjectionMode</p>
                                    <p class="text-sm"><strong>è§¦å‘è§„åˆ™:</strong> @(string.IsNullOrEmpty(term.TriggerRule) ? "æ— " : term.TriggerRule)</p>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- æ·»åŠ  DynPromptTerm -->
            <div class="mt-4">
                <h4>æ·»åŠ æ–°çš„åŠ¨æ€æç¤ºè¯</h4>
                <button class="btn mt-2" @onclick="ShowAddTermForm">+ æ·»åŠ æç¤ºè¯</button>
            </div>
        </div>
    }

    <!-- ç¼–è¾‘æˆ–æ·»åŠ  DynPromptTerm çš„è¡¨å• -->
    @if (showTermForm)
    {
        <div class="shimmer-popup-overlay">
            <div class="shimmer-popup-content">
                <h4>@(isEditingTerm ? "ç¼–è¾‘åŠ¨æ€æç¤ºè¯" : "æ·»åŠ æ–°åŠ¨æ€æç¤ºè¯")</h4>
                
                <div class="form-group mt-3">
                    <label>åç§°:</label>
                    <input type="text" class="shimmer-input @(validationErrors.ContainsKey("termName") ? "border-danger" : "")" 
                           @bind="termForm.Name" placeholder="è¾“å…¥æç¤ºè¯åç§°" />
                    @if (validationErrors.ContainsKey("termName"))
                    {
                        <div class="text-danger text-sm mt-1">@validationErrors["termName"]</div>
                    }
                </div>
                
                <div class="form-group mt-3">
                    <label>å†…å®¹:</label>
                    <textarea class="shimmer-textarea @(validationErrors.ContainsKey("termContent") ? "border-danger" : "")" 
                              @bind="termForm.Content" placeholder="è¾“å…¥æç¤ºè¯å†…å®¹" rows="5"></textarea>
                    @if (validationErrors.ContainsKey("termContent"))
                    {
                        <div class="text-danger text-sm mt-1">@validationErrors["termContent"]</div>
                    }
                </div>
                
                <div class="form-group mt-3">
                    <label>æ³¨å…¥æ¨¡å¼:</label>
                    <select class="shimmer-input" @bind="termForm.InjectionMode">
                        @foreach (var mode in Enum.GetValues(typeof(DynPromptTermInjectionMode)))
                        {
                            <option value="@mode">@mode</option>
                        }
                    </select>
                </div>
                
                <div class="form-group mt-3">
                    <label>æ³¨å…¥æ·±åº¦ (å½“æ¨¡å¼ä¸º AtDepth æ—¶æœ‰æ•ˆ):</label>
                    <input type="number" class="shimmer-input" @bind="termForm.InjectionDepth" min="1" />
                </div>
                
                <div class="form-group mt-3">
                    <label>è§¦å‘è§„åˆ™:</label>
                    <textarea class="shimmer-textarea @(validationErrors.ContainsKey("termTriggerRule") ? "border-danger" : "")" 
                              @bind="termForm.TriggerRule" placeholder="è¾“å…¥è§¦å‘è§„åˆ™ï¼Œç•™ç©ºè¡¨ç¤ºå§‹ç»ˆè§¦å‘" rows="3"></textarea>
                    @if (validationErrors.ContainsKey("termTriggerRule"))
                    {
                        <div class="text-danger text-sm mt-1">@validationErrors["termTriggerRule"]</div>
                    }
                    <small class="text-muted mt-1">æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼å’Œé€»è¾‘è¿ç®—ç¬¦: | (æˆ–), & (ä¸), ! (é), () (åˆ†ç»„)</small>
                </div>
                
                <div class="form-group mt-3">
                    <div class="d-flex items-center gap-2">
                        <input type="checkbox" id="allowRecursive" @bind="termForm.AllowBeTriggeredByRecursive" />
                        <label for="allowRecursive">å…è®¸è¢«é€’å½’è§¦å‘</label>
                    </div>
                </div>
                
                <div class="form-actions d-flex gap-3 justify-end mt-4">
                    <button class="btn bg-danger text-white" @onclick="CancelTermForm">å–æ¶ˆ</button>
                    <button class="btn" @onclick="SaveTerm">ä¿å­˜</button>
                </div>
            </div>
        </div>
    }

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    @if (isLoading)
    {
        <div class="shimmer-popup-overlay">
            <div class="shimmer-popup-content text-center">
                <div class="text-primary mb-3">â³</div>
                <div class="text-lg">å¤„ç†ä¸­...</div>
            </div>
        </div>
    }

    <!-- ä¿å­˜å’ŒçŠ¶æ€æ¶ˆæ¯ -->
    <div class="mt-5 pt-3 border-t">
        <div class="d-flex justify-between items-center">
            <button class="btn" @onclick="SaveAllChanges" disabled="@isLoading">ä¿å­˜æ‰€æœ‰æ›´æ”¹</button>
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="px-4 py-2 rounded-md text-sm 
                            @(statusType == "success" ? "bg-success/10 text-success" : 
                              statusType == "error" ? "bg-error/10 text-error" : "bg-info/10 text-info")">
                    <span>
                        @(statusType == "success" ? "âœ“" : statusType == "error" ? "âœ—" : "i") 
                        @statusMessage
                    </span>
                </div>
            }
        </div>
    </div>
</div>

@code {
    List<DynPromptSet> sets = [];
    DynPromptSet? selectedSet = null;
    string newSetName = "";
    string editingSetName = "";
    DynPromptTerm? editingTerm = null;
    bool showTermForm = false;
    bool isEditingTerm = false;
    string statusMessage = "";
    string statusType = "info"; // info, success, error

    // è¡¨å•æ•°æ®
    DynPromptTerm termForm = new()
    {
        Name = "",
        Content = "",
        InjectionMode = DynPromptTermInjectionMode.BeforeSystem,
        InjectionDepth = 4,
        TriggerRule = "",
        AllowBeTriggeredByRecursive = false
    };

    // åŠ è½½çŠ¶æ€
    bool isLoading = false;
    // è¡¨å•éªŒè¯é”™è¯¯
    Dictionary<string, string> validationErrors = new();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        LoadDynPromptSets();
    }

    void LoadDynPromptSets()
    {
        try
        {
            isLoading = true;
            var data = pluginData.Read("DynPrompt", "DynPromptSets");
            sets = JsonConvert.DeserializeObject<List<DynPromptSet>>(data ?? "[]") ?? [];
            ShowStatus("æ•°æ®åŠ è½½æˆåŠŸ", "success");
        }
        catch (Exception ex)
        {
            ShowStatus($"åŠ è½½æ•°æ®å¤±è´¥: {ex.Message}", "error");
            sets = [];
        }
        finally
        {
            isLoading = false;
        }
    }

    // éªŒè¯è§¦å‘è§„åˆ™çš„æ­£åˆ™è¡¨è¾¾å¼
    bool ValidateTriggerRule(string rule)
    {
        if (string.IsNullOrEmpty(rule))
            return true;

        try
        {
            // ç®€å•çš„è¯­æ³•éªŒè¯ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„éªŒè¯
            // è¿™é‡Œæˆ‘ä»¬åªæ˜¯æ£€æŸ¥æ‹¬å·æ˜¯å¦åŒ¹é…
            int bracketCount = 0;
            foreach (char c in rule)
            {
                if (c == '(')
                    bracketCount++;
                else if (c == ')')
                    bracketCount--;
                
                if (bracketCount < 0)
                    return false;
            }
            return bracketCount == 0;
        }
        catch
        {
            return false;
        }
    }

    void CreateNewSet()
    {
        // æ¸…é™¤ä¹‹å‰çš„éªŒè¯é”™è¯¯
        ClearValidationErrors();
        
        if (string.IsNullOrWhiteSpace(newSetName))
        {
            AddValidationError("newSetName", "è¯·è¾“å…¥æœ‰æ•ˆçš„é›†åˆåç§°");
            ShowStatus("è¯·è¾“å…¥æœ‰æ•ˆçš„é›†åˆåç§°", "error");
            return;
        }

        if (sets.Any(s => s.Name == newSetName))
        {
            AddValidationError("newSetName", "é›†åˆåç§°å·²å­˜åœ¨");
            ShowStatus("é›†åˆåç§°å·²å­˜åœ¨", "error");
            return;
        }

        try
        {
            isLoading = true;
            var newSet = new DynPromptSet { Name = newSetName };
            sets.Add(newSet);
            selectedSet = newSet;
            editingSetName = newSetName;
            newSetName = "";
            ShowStatus("é›†åˆåˆ›å»ºæˆåŠŸ", "success");
            
            // è‡ªåŠ¨ä¿å­˜
            SaveAllChanges();
        }
        catch (Exception ex)
        {
            ShowStatus($"åˆ›å»ºé›†åˆå¤±è´¥: {ex.Message}", "error");
        }
        finally
        {
            isLoading = false;
        }
    }

    void AddValidationError(string field, string message)
    {
        validationErrors[field] = message;
    }

    void ClearValidationErrors()
    {
        validationErrors.Clear();
    }

    void EditSet(DynPromptSet set)
    {
        selectedSet = set;
        editingSetName = set.Name;
    }

    async Task DeleteSet(DynPromptSet set)
    {
        try
        {
            // ä½¿ç”¨JSInteropè°ƒç”¨æµè§ˆå™¨çš„confirmå‡½æ•°
            bool confirmed = await JS.InvokeAsync<bool>("confirm", 
                $"ç¡®å®šè¦åˆ é™¤é›†åˆ '{set.Name}' å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³çš„åŠ¨æ€æç¤ºè¯ã€‚");
            
            if (confirmed)
            {
                 isLoading = true;
                 sets.Remove(set);
                 if (selectedSet == set)
                 {
                     selectedSet = null;
                     editingSetName = "";
                 }
                 ShowStatus("é›†åˆå·²åˆ é™¤", "success");
                 
                 // è‡ªåŠ¨ä¿å­˜
                 SaveAllChanges();
            }
        }
        catch (Exception ex)
        {
            ShowStatus($"åˆ é™¤é›†åˆå¤±è´¥: {ex.Message}", "error");
        }
        finally
        {
            isLoading = false;
        }
    }

    void UpdateSetName()
    {
        if (selectedSet == null || string.IsNullOrWhiteSpace(editingSetName))
        {
            ShowStatus("è¯·è¾“å…¥æœ‰æ•ˆçš„é›†åˆåç§°", "error");
            return;
        }

        if (sets.Any(s => s.Name == editingSetName && s != selectedSet))
        {
            ShowStatus("é›†åˆåç§°å·²å­˜åœ¨", "error");
            return;
        }

        selectedSet.Name = editingSetName;
        ShowStatus("é›†åˆåç§°å·²æ›´æ–°", "success");
        
        // è‡ªåŠ¨ä¿å­˜
        SaveAllChanges();
    }

    void ShowAddTermForm()
    {
        if (selectedSet == null)
        {
            ShowStatus("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé›†åˆ", "error");
            return;
        }

        isEditingTerm = false;
        termForm = new()
        {
            Name = "",
            Content = "",
            InjectionMode = DynPromptTermInjectionMode.BeforeSystem,
            InjectionDepth = 4,
            TriggerRule = "",
            AllowBeTriggeredByRecursive = false
        };
        showTermForm = true;
    }

    void EditTerm(DynPromptTerm term)
    {
        editingTerm = term;
        isEditingTerm = true;
        termForm = new()
        {
            Name = term.Name,
            Content = term.Content,
            InjectionMode = term.InjectionMode,
            InjectionDepth = term.InjectionDepth,
            TriggerRule = term.TriggerRule,
            AllowBeTriggeredByRecursive = term.AllowBeTriggeredByRecursive
        };
        showTermForm = true;
    }

    async Task DeleteTerm(DynPromptTerm term)
    {
        try
        {
            if (selectedSet != null)
            {
                // ä½¿ç”¨JSInteropè°ƒç”¨æµè§ˆå™¨çš„confirmå‡½æ•°
                bool confirmed = await JS.InvokeAsync<bool>("confirm", 
                    $"ç¡®å®šè¦åˆ é™¤æç¤ºè¯ '{term.Name}' å—ï¼Ÿ");
                
                if (confirmed)
                {
                    isLoading = true;
                    selectedSet.Terms.Remove(term);
                    if (editingTerm == term)
                    {
                        editingTerm = null;
                    }
                    ShowStatus("æç¤ºè¯å·²åˆ é™¤", "success");
                    
                    // è‡ªåŠ¨ä¿å­˜
                    SaveAllChanges();
                }
            }
        }
        catch (Exception ex)
        {
            ShowStatus($"åˆ é™¤æç¤ºè¯å¤±è´¥: {ex.Message}", "error");
        }
        finally
        {
            isLoading = false;
        }
    }

    void SaveTerm()
    {
        // æ¸…é™¤ä¹‹å‰çš„éªŒè¯é”™è¯¯
        ClearValidationErrors();
        
        if (selectedSet == null)
        {
            ShowStatus("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé›†åˆ", "error");
            return;
        }

        // éªŒè¯å¿…å¡«å­—æ®µ
        if (string.IsNullOrWhiteSpace(termForm.Name))
        {
            AddValidationError("termName", "è¯·è¾“å…¥æç¤ºè¯åç§°");
        }

        if (string.IsNullOrWhiteSpace(termForm.Content))
        {
            AddValidationError("termContent", "è¯·è¾“å…¥æç¤ºè¯å†…å®¹");
        }

        // éªŒè¯è§¦å‘è§„åˆ™
        if (!ValidateTriggerRule(termForm.TriggerRule))
        {
            AddValidationError("termTriggerRule", "è§¦å‘è§„åˆ™è¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‹¬å·æ˜¯å¦åŒ¹é…");
        }

        // æ£€æŸ¥åç§°å†²çª
        if (!string.IsNullOrWhiteSpace(termForm.Name))
        {
            if (isEditingTerm && editingTerm != null)
            {
                if (selectedSet.Terms.Any(t => t.Name == termForm.Name && t != editingTerm))
                {
                    AddValidationError("termName", "æç¤ºè¯åç§°å·²å­˜åœ¨");
                }
            }
            else
            {
                if (selectedSet.Terms.Any(t => t.Name == termForm.Name))
                {
                    AddValidationError("termName", "æç¤ºè¯åç§°å·²å­˜åœ¨");
                }
            }
        }

        // å¦‚æœæœ‰éªŒè¯é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (validationErrors.Count > 0)
        {
            ShowStatus("è¯·ä¿®æ­£è¡¨å•ä¸­çš„é”™è¯¯", "error");
            StateHasChanged();
            return;
        }

        try
        {
            isLoading = true;
            
            if (isEditingTerm && editingTerm != null)
            {
                // æ›´æ–°ç°æœ‰é¡¹
                editingTerm.Name = termForm.Name;
                editingTerm.Content = termForm.Content;
                editingTerm.InjectionMode = termForm.InjectionMode;
                editingTerm.InjectionDepth = termForm.InjectionDepth;
                editingTerm.TriggerRule = termForm.TriggerRule;
                editingTerm.AllowBeTriggeredByRecursive = termForm.AllowBeTriggeredByRecursive;
                ShowStatus("æç¤ºè¯å·²æ›´æ–°", "success");
            }
            else
            {
                // æ·»åŠ æ–°é¡¹
                var newTerm = new DynPromptTerm
                {
                    Name = termForm.Name,
                    Content = termForm.Content,
                    InjectionMode = termForm.InjectionMode,
                    InjectionDepth = termForm.InjectionDepth,
                    TriggerRule = termForm.TriggerRule,
                    AllowBeTriggeredByRecursive = termForm.AllowBeTriggeredByRecursive
                };
                selectedSet.Terms.Add(newTerm);
                ShowStatus("æç¤ºè¯å·²æ·»åŠ ", "success");
            }

            CancelTermForm();
                
                // è‡ªåŠ¨ä¿å­˜
                SaveAllChanges();
            }
            catch (Exception ex)
            {
                ShowStatus($"ä¿å­˜æç¤ºè¯å¤±è´¥: {ex.Message}", "error");
            }
            finally
            {
                isLoading = false;
            }
    }

    void CancelTermForm()
    {
        showTermForm = false;
        editingTerm = null;
        isEditingTerm = false;
    }

    void SaveAllChanges()
    {
        try
        {
            isLoading = true;
            
            // éªŒè¯æ‰€æœ‰æ•°æ®
            bool hasErrors = false;
            foreach (var set in sets)
            {
                if (string.IsNullOrWhiteSpace(set.Name))
                {
                    hasErrors = true;
                    ShowStatus("å­˜åœ¨æ— æ•ˆçš„é›†åˆåç§°", "error");
                    break;
                }
                
                foreach (var term in set.Terms)
                {
                    if (string.IsNullOrWhiteSpace(term.Name) || string.IsNullOrWhiteSpace(term.Content))
                    {
                        hasErrors = true;
                        ShowStatus("å­˜åœ¨æ— æ•ˆçš„æç¤ºè¯", "error");
                        break;
                    }
                    
                    if (!ValidateTriggerRule(term.TriggerRule))
                    {
                        hasErrors = true;
                        ShowStatus($"æç¤ºè¯ '{term.Name}' çš„è§¦å‘è§„åˆ™è¯­æ³•é”™è¯¯", "error");
                        break;
                    }
                }
                
                if (hasErrors)
                    break;
            }
            
            if (hasErrors)
                return;
            
            var json = JsonConvert.SerializeObject(sets, Formatting.Indented);
            pluginData.Write("DynPrompt", "DynPromptSets", json);
            ShowStatus("æ‰€æœ‰æ›´æ”¹å·²ä¿å­˜", "success");
        }
        catch (Exception ex)
        {
            ShowStatus($"ä¿å­˜å¤±è´¥: {ex.Message}", "error");
        }
        finally
        {
            isLoading = false;
        }
    }

    void ShowStatus(string message, string type)
    {
        statusMessage = message;
        statusType = type;
        // 3ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
        InvokeAsync(async () =>
        {
            await Task.Delay(3000);
            statusMessage = "";
            StateHasChanged();
        });
    }

    // ç§»é™¤æ¨¡æ‹Ÿçš„confirmå‡½æ•°ï¼Œç°åœ¨ä½¿ç”¨JSInterop
}